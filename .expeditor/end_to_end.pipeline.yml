expeditor:
  secrets:
    PIPELINE_HAB_AUTH_TOKEN:
      path: account/static/habitat/chef-ci
      field: auth_token # Production Builder
  accounts:
    - aws/chef-cd
  defaults:
    buildkite:
      timeout_in_minutes: 30
      env:
        HAB_ORIGIN: "habitat-testing" # just to be safe
        HAB_BLDR_URL: "https://bldr.habitat.sh"

        # In "real" runs of this pipeline, this channel must always
        # be "dev". It is extracted here as an environment variable
        # (thus making it overridable) in order to facilitate ad-hoc
        # testing of artifacts from arbitrary channels (e.g., as part
        # of validating a core plans refresh).
        HAB_BLDR_CHANNEL: "dev"

steps:
#######################################################################
# E2E
#######################################################################

  - label: ":docker: Docker End-to-End Supervisor Tests"
    command:
      - cd test/end-to-end/multi-supervisor
      - ./run_all.sh \$HAB_BLDR_CHANNEL
    expeditor:
      executor:
        linux:
          privileged: true
    artifact_paths:
      - "test/end-to-end/multi-supervisor/habitat_integration_output/**"

  - label: "[:linux: test_hab_help_doesnt_install_hab_sup]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_hab_help_doesnt_install_hab_sup
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: hup-does-not-abandon-services]"
    command:
      - .expeditor/scripts/end_to_end/setup_environment.sh \$HAB_BLDR_CHANNEL
      - hab pkg install --binlink --channel=stable core/expect
      - hab pkg install --channel=\$HAB_BLDR_CHANNEL core/hab-sup core/hab-launcher
      - test/end-to-end/hup-does-not-abandon-services.exp
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: hab-svc-load]"
    command:
      - .expeditor/scripts/end_to_end/setup_environment.sh \$HAB_BLDR_CHANNEL
      - hab pkg install --binlink --channel=stable core/expect
      - hab pkg install --channel=\$HAB_BLDR_CHANNEL core/hab-sup core/hab-launcher
      - test/end-to-end/hab-svc-load.exp
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:windows: hab-svc-load]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_supervisor_load_service
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: Start-Service]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_supervisor_windows_service
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: cleanly-shutdown-supervisor]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_supervisor_windows_shutdown
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: hab-svc-load-with-svc-user]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_supervisor_load_service_with_password
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: test_supervisor_binds]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_supervisor_binds
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_supervisor_binds]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_supervisor_binds
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_STUDIO_SECRET_HAB_INTERNAL_BLDR_CHANNEL=\$HAB_BLDR_CHANNEL
            - HAB_STUDIO_SECRET_CI_OVERRIDE_CHANNEL=\$HAB_BLDR_CHANNEL

  - label: "[:windows: test_supervisor_term]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_supervisor_term
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN

  - label: "[:linux: test_supervisor_term]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_supervisor_term
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_STUDIO_SECRET_HAB_INTERNAL_BLDR_CHANNEL=\$HAB_BLDR_CHANNEL
            - HAB_STUDIO_SECRET_CI_OVERRIDE_CHANNEL=\$HAB_BLDR_CHANNEL

  - label: "[:windows: hab-svc-load-with-hab-user]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_supervisor_load_with_hab_user
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_launcher_checks_supervisor_version]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_launcher_checks_supervisor_version
    artifact_paths:
      - sup.log
    soft_fail: true
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_STUDIO_SECRET_HAB_INTERNAL_BLDR_CHANNEL=\$HAB_BLDR_CHANNEL
            - HAB_STUDIO_SECRET_CI_OVERRIDE_CHANNEL=\$HAB_BLDR_CHANNEL

  - label: "[:linux: test_launcher_exits_on_supervisor_connection_failure]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_launcher_exits_on_supervisor_connection_failure
    artifact_paths:
      - sup.log
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_launcher_exits_on_supervisor_startup_failure]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_launcher_exits_on_supervisor_startup_failure
    artifact_paths:
      - sup.log
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_supervisor_restarts]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_supervisor_restarts
    artifact_paths:
      - sup.log
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_socket_file_cleanup]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_socket_file_cleanup
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_tar_export]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_tar_export
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:windows: test_tar_export]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_tar_export
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_studio_auto_installs]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_studio_auto_installs
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL
            - HAB_ORIGIN

  - label: "[:linux: test_studio_with_ssl_cert_file_envvar_set]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_studio_with_ssl_cert_file_envvar_set
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL
            - HAB_ORIGIN

  - label: "[:windows: test_studio_with_ssl_cert_file_envvar_set]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_studio_with_ssl_cert_file_envvar_set
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: :docker: test_studio_with_ssl_cert_file_envvar_set]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_studio_with_ssl_cert_file_envvar_set
    env:
      BUILD_PKG_TARGET: x86_64-linux
      STUDIO_DOCKER_TEST: true
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "[:windows: test_studio_version]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_studio_version
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: 2019 :docker: test_studio_version]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_studio_version
    env:
      BUILD_PKG_TARGET: x86_64-windows
      DOCKER_STUDIO_TEST: true
    expeditor:
      executor:
        windows:
    retry:
      automatic:
        limit: 1

  - label: "[:windows: 2016 :docker: test_studio_version]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_studio_version
    env:
      BUILD_PKG_TARGET: x86_64-windows
      DOCKER_STUDIO_TEST: true
    expeditor:
      executor:
        windows:
          os_version: 2016
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_studio_version]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_studio_version
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL
            - HAB_ORIGIN
            - HAB_STUDIO_SECRET_HAB_INTERNAL_BLDR_CHANNEL=\$HAB_BLDR_CHANNEL

  - label: "[:linux: :docker: test_studio_version]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_studio_version
    env:
      BUILD_PKG_TARGET: x86_64-linux
      DOCKER_STUDIO_TEST: true
      HAB_STUDIO_SECRET_HAB_INTERNAL_BLDR_CHANNEL: \$HAB_BLDR_CHANNEL
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "[:windows: test_studio_supervisor]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_studio_supervisor
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: :docker: test_studio_supervisor]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_studio_supervisor
    env:
      BUILD_PKG_TARGET: x86_64-windows
      DOCKER_STUDIO_TEST: true
    expeditor:
      executor:
        windows:
    retry:
      automatic:
        limit: 1

  - label: "[:windows: test_studio_profile]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_studio_profile
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: :docker: test_studio_profile]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_studio_profile
    env:
      BUILD_PKG_TARGET: x86_64-windows
      DOCKER_STUDIO_TEST: true
    expeditor:
      executor:
        windows:
          os_version: 2019
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_fresh_install_can_communicate_with_builder]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_fresh_install_can_communicate_with_builder
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_BLDR_URL

  - label: "[:linux: test_studio_can_build_packages]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_studio_can_build_packages
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_ORIGIN

  - label: "[:windows: test_studio_can_build_packages]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_studio_can_build_packages
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: test_studio_can_build_packages_with_pkg_version_function]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_studio_can_build_packages_with_pkg_version_function
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: test_studio_can_build_scaffolded_package]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_studio_can_build_scaffolded_package
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_studio_unmount_with_long_filesystem]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_studio_unmount_with_long_filesystem
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "[:linux: test_self_signed_cert_is_loaded_by_hab]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_self_signed_cert_is_loaded_by_hab
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:windows: test_windows_service_stops_on_launcher_termination]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_windows_service_stops_on_launcher_termination
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: test_ssl_certificate_loading]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_ssl_certificate_loading
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:windows: test_pkg_install]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_pkg_install
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_pkg_install]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_pkg_install
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_pkg_download]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_pkg_download
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_pkg_bulkupload]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_pkg_bulkupload
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - PIPELINE_HAB_AUTH_TOKEN
            - PIPELINE_HAB_BLDR_URL=https://bldr.habitat.sh
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_simple_hooks]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_simple_hooks
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:windows: test_simple_hooks]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_simple_hooks
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test pids from Launcher with compatible Launcher]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_service_pids_come_from_new_launcher
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test service PID files with old Launcher]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_service_pids_written_to_file_using_old_launcher
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_event_stream]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_event_stream
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_at_once_service_updater]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_at_once_service_updater
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_UPDATE_STRATEGY_FREQUENCY_MS=3000
            - HAB_UPDATE_STRATEGY_FREQUENCY_BYPASS_CHECK=1

  - label: "[:linux: test_self_keep_latest_packages]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_self_keep_latest_packages
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_pkg_uninstall]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_pkg_uninstall
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_pkg_uninstall_hook]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_pkg_uninstall_hook
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:windows: test_pkg_uninstall_hook]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_pkg_uninstall_hook
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - HAB_ORIGIN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_container_exporter]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh $HAB_BLDR_CHANNEL test_container_exporter
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "[:windows: test_container_exporter]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_container_exporter
    env:
      BUILD_PKG_TARGET: x86_64-windows
    expeditor:
      executor:
        windows:
          privileged: true


  - label: "[:linux: test_svc_update]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_svc_update
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - PIPELINE_HAB_AUTH_TOKEN

  - label: "[:windows: test_svc_update]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_svc_update
    env:
      BUILD_PKG_TARGET: x86_64-windows
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - PIPELINE_HAB_AUTH_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_config_files]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh $HAB_BLDR_CHANNEL test_config_files
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - PIPELINE_HAB_AUTH_TOKEN

  - label: "[:windows: test_config_files]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 $HAB_BLDR_CHANNEL test_config_files
    env:
      BUILD_PKG_TARGET: x86_64-windows
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - PIPELINE_HAB_AUTH_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_alternate_error_exit_codes]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_alternate_error_exit_codes
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - PIPELINE_HAB_AUTH_TOKEN

  - label: "[:windows: test_alternate_error_exit_codes]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_alternate_error_exit_codes
    env:
      BUILD_PKG_TARGET: x86_64-windows
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - PIPELINE_HAB_AUTH_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_supplemental_groups]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_supplemental_groups
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_license]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_license
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: test_external_binaries]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_external_binaries
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - PIPELINE_HAB_AUTH_TOKEN

  - label: "[:windows: test_external_binaries]"
    command:
      - powershell .expeditor/scripts/end_to_end/run_e2e_test.ps1 \$HAB_BLDR_CHANNEL test_external_binaries
    env:
      BUILD_PKG_TARGET: x86_64-windows
    expeditor:
      executor:
        docker:
          host_os: windows
          environment:
            - BUILD_PKG_TARGET=x86_64-windows
            - BUILDKITE_AGENT_ACCESS_TOKEN
            - PIPELINE_HAB_AUTH_TOKEN
    retry:
      automatic:
        limit: 1

  - label: "[:linux: test_cli_config_file]"
    command:
      - bash .expeditor/scripts/end_to_end/run_e2e_test.sh \$HAB_BLDR_CHANNEL test_cli_config_file
    env:
      BUILD_PKG_TARGET: x86_64-linux
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - PIPELINE_HAB_AUTH_TOKEN

  - wait

  - label: "[:habicat: Promote to Acceptance]"
    command:
      # Using $HAB_BLDR_CHANNEL here, rather than hard-coding "dev"
      # for overall consistency. However, that means that the `if`
      # condition limiting this to only Expeditor-initiated runs is
      # VERY IMPORTANT. "Real" runs of this pipeline should only use
      # "dev" as the channel to pull from!
      - .expeditor/scripts/buildkite_promote.sh \$HAB_BLDR_CHANNEL acceptance
    if: build.creator.name == 'Chef Expeditor'
    expeditor:
      executor:
        docker:
          privileged: true
